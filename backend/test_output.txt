============================= test session starts =============================
platform win32 -- Python 3.13.5, pytest-9.0.2, pluggy-1.6.0
rootdir: C:\Users\jhapg\OneDrive\Desktop\ClassGrid\backend
configfile: pytest.ini
testpaths: tests
plugins: anyio-4.10.0, asyncio-1.3.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 17 items

tests\core\test_db.py F                                                  [  5%]
tests\routers\test_admin_users.py EEEE                                   [ 29%]
tests\routers\test_admin_users_mock.py FFFF                              [ 52%]
tests\routers\test_auth.py F                                             [ 58%]
tests\routers\test_users.py EEEE                                         [ 82%]
tests\routers\test_users_mock.py FF                                      [ 94%]
tests\test_sample.py .                                                   [100%]

=================================== ERRORS ====================================
___________________ ERROR at setup of test_admin_list_users ___________________
file C:\Users\jhapg\OneDrive\Desktop\ClassGrid\backend\tests\routers\test_admin_users.py, line 8
  @pytest.mark.asyncio
  async def test_admin_list_users(admin_token):
      async with AsyncClient(
          transport=ASGITransport(app=app), base_url="http://test"
      ) as ac:
          response = await ac.get(
              "/users",
              headers={"Authorization": f"Bearer {admin_token}"},
          )
      assert response.status_code == 200
      assert isinstance(response.json(), list)
      assert len(response.json()) >= 1  # At least the admin exists
E       fixture 'admin_token' not found
>       available fixtures: _class_scoped_runner, _function_scoped_runner, _module_scoped_runner, _package_scoped_runner, _session_scoped_runner, anyio_backend, anyio_backend_name, anyio_backend_options, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, capteesys, doctest_namespace, event_loop_policy, free_tcp_port, free_tcp_port_factory, free_udp_port, free_udp_port_factory, initialize_database, monkeypatch, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, subtests, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory
>       use 'pytest --fixtures [testpath]' for help on them.

C:\Users\jhapg\OneDrive\Desktop\ClassGrid\backend\tests\routers\test_admin_users.py:8
____________________ ERROR at setup of test_admin_get_user ____________________
file C:\Users\jhapg\OneDrive\Desktop\ClassGrid\backend\tests\routers\test_admin_users.py, line 22
  @pytest.mark.asyncio
  async def test_admin_get_user(admin_token):
      # Retrieve self
      async with AsyncClient(
          transport=ASGITransport(app=app), base_url="http://test"
      ) as ac:
          response = await ac.get(
              "/users/admin_user",
              headers={"Authorization": f"Bearer {admin_token}"},
          )
      assert response.status_code == 200
      assert response.json()["user_id"] == "admin_user"
E       fixture 'admin_token' not found
>       available fixtures: _class_scoped_runner, _function_scoped_runner, _module_scoped_runner, _package_scoped_runner, _session_scoped_runner, anyio_backend, anyio_backend_name, anyio_backend_options, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, capteesys, doctest_namespace, event_loop_policy, free_tcp_port, free_tcp_port_factory, free_udp_port, free_udp_port_factory, initialize_database, monkeypatch, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, subtests, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory
>       use 'pytest --fixtures [testpath]' for help on them.

C:\Users\jhapg\OneDrive\Desktop\ClassGrid\backend\tests\routers\test_admin_users.py:22
__________________ ERROR at setup of test_admin_update_user ___________________
file C:\Users\jhapg\OneDrive\Desktop\ClassGrid\backend\tests\routers\test_admin_users.py, line 36
  @pytest.mark.asyncio
  async def test_admin_update_user(admin_token):
      # Create a user to update
      user = User(
          user_id="update_test",
          firstname="Update",
          lastname="Test",
          hashed_password=get_password_hash("pass"),
          role=UserRole.instructor,
      )
      await user.create()

      async with AsyncClient(
          transport=ASGITransport(app=app), base_url="http://test"
      ) as ac:
          response = await ac.put(
              "/users/update_test",
              json={"firstname": "UpdatedName", "password": "newpassword"},
              headers={"Authorization": f"Bearer {admin_token}"},
          )

      assert response.status_code == 200
      data = response.json()
      assert data["firstname"] == "UpdatedName"

      # Verify DB update
      updated_user = await User.find_one(User.user_id == "update_test")
      assert updated_user.firstname == "UpdatedName"
      assert updated_user.hashed_password != get_password_hash(
          "pass"
      )  # Should be changed
E       fixture 'admin_token' not found
>       available fixtures: _class_scoped_runner, _function_scoped_runner, _module_scoped_runner, _package_scoped_runner, _session_scoped_runner, anyio_backend, anyio_backend_name, anyio_backend_options, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, capteesys, doctest_namespace, event_loop_policy, free_tcp_port, free_tcp_port_factory, free_udp_port, free_udp_port_factory, initialize_database, monkeypatch, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, subtests, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory
>       use 'pytest --fixtures [testpath]' for help on them.

C:\Users\jhapg\OneDrive\Desktop\ClassGrid\backend\tests\routers\test_admin_users.py:36
__________________ ERROR at setup of test_admin_delete_user ___________________
file C:\Users\jhapg\OneDrive\Desktop\ClassGrid\backend\tests\routers\test_admin_users.py, line 69
  @pytest.mark.asyncio
  async def test_admin_delete_user(admin_token):
      # Create a user to delete
      user = User(
          user_id="delete_test",
          firstname="Delete",
          lastname="Test",
          hashed_password=get_password_hash("pass"),
          role=UserRole.instructor,
      )
      await user.create()

      async with AsyncClient(
          transport=ASGITransport(app=app), base_url="http://test"
      ) as ac:
          response = await ac.delete(
              "/users/delete_test",
              headers={"Authorization": f"Bearer {admin_token}"},
          )

      assert response.status_code == 200
      assert response.json()["user_id"] == "delete_test"

      # Verify DB deletion
      deleted_user = await User.find_one(User.user_id == "delete_test")
      assert deleted_user is None
E       fixture 'admin_token' not found
>       available fixtures: _class_scoped_runner, _function_scoped_runner, _module_scoped_runner, _package_scoped_runner, _session_scoped_runner, anyio_backend, anyio_backend_name, anyio_backend_options, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, capteesys, doctest_namespace, event_loop_policy, free_tcp_port, free_tcp_port_factory, free_udp_port, free_udp_port_factory, initialize_database, monkeypatch, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, subtests, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory
>       use 'pytest --fixtures [testpath]' for help on them.

C:\Users\jhapg\OneDrive\Desktop\ClassGrid\backend\tests\routers\test_admin_users.py:69
_______________ ERROR at setup of test_admin_create_instructor ________________

    @pytest_asyncio.fixture
    async def admin_token():
        # init_db handled by autouse fixture in conftest
        # Create or update admin
        admin_id = "admin_user"
>       user = await User.find_one(User.user_id == admin_id)
                                   ^^^^^^^^^^^^

tests\routers\test_users.py:15: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <class 'app.models.user.User'>, item = 'user_id'

    def __getattr__(self, item: str) -> Any:
        """This is necessary to keep attribute access working for class attribute access."""
        private_attributes = self.__dict__.get('__private_attributes__')
        if private_attributes and item in private_attributes:
            return private_attributes[item]
>       raise AttributeError(item)
E       AttributeError: user_id

..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\pydantic\_internal\_model_construction.py:271: AttributeError
___________ ERROR at setup of test_admin_create_program_chairperson ___________

    @pytest_asyncio.fixture
    async def admin_token():
        # init_db handled by autouse fixture in conftest
        # Create or update admin
        admin_id = "admin_user"
>       user = await User.find_one(User.user_id == admin_id)
                                   ^^^^^^^^^^^^

tests\routers\test_users.py:15: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <class 'app.models.user.User'>, item = 'user_id'

    def __getattr__(self, item: str) -> Any:
        """This is necessary to keep attribute access working for class attribute access."""
        private_attributes = self.__dict__.get('__private_attributes__')
        if private_attributes and item in private_attributes:
            return private_attributes[item]
>       raise AttributeError(item)
E       AttributeError: user_id

..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\pydantic\_internal\_model_construction.py:271: AttributeError
_______________ ERROR at setup of test_user_cannot_create_user ________________

    @pytest_asyncio.fixture
    async def user_token():
        # Create or update normal user (now defaulting to instructor as student is removed)
        user_id = "normal_user"
>       user = await User.find_one(User.user_id == user_id)
                                   ^^^^^^^^^^^^

tests\routers\test_users.py:36: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <class 'app.models.user.User'>, item = 'user_id'

    def __getattr__(self, item: str) -> Any:
        """This is necessary to keep attribute access working for class attribute access."""
        private_attributes = self.__dict__.get('__private_attributes__')
        if private_attributes and item in private_attributes:
            return private_attributes[item]
>       raise AttributeError(item)
E       AttributeError: user_id

..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\pydantic\_internal\_model_construction.py:271: AttributeError
__________________ ERROR at setup of test_admin_create_admin __________________

    @pytest_asyncio.fixture
    async def admin_token():
        # init_db handled by autouse fixture in conftest
        # Create or update admin
        admin_id = "admin_user"
>       user = await User.find_one(User.user_id == admin_id)
                                   ^^^^^^^^^^^^

tests\routers\test_users.py:15: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <class 'app.models.user.User'>, item = 'user_id'

    def __getattr__(self, item: str) -> Any:
        """This is necessary to keep attribute access working for class attribute access."""
        private_attributes = self.__dict__.get('__private_attributes__')
        if private_attributes and item in private_attributes:
            return private_attributes[item]
>       raise AttributeError(item)
E       AttributeError: user_id

..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\pydantic\_internal\_model_construction.py:271: AttributeError
================================== FAILURES ===================================
_____________________________ test_db_connection ______________________________

    @pytest.mark.asyncio
    async def test_db_connection():
        # Initialize Beanie handled by conftest
        pass
    
        # Create an item
>       item = Item(name="Test Item", price=10.0)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\core\test_db.py:12: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\beanie\odm\documents.py:209: in __init__
    self.get_pymongo_collection()
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\beanie\odm\interfaces\getters.py:16: in get_pymongo_collection
    return cls.get_settings().pymongo_collection
           ^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

cls = <class 'app.models.item.Item'>

    @classmethod
    def get_settings(cls) -> DocumentSettings:
        """
        Get document settings, which was created on
        the initialization step
    
        :return: DocumentSettings class
        """
        if cls._document_settings is None:
>           raise CollectionWasNotInitialized
E           beanie.exceptions.CollectionWasNotInitialized

..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\beanie\odm\documents.py:1110: CollectionWasNotInitialized
_________________________ test_admin_list_users_mock __________________________

mock_user_db_admin = <MagicMock name='User' id='1900246475376'>

    @pytest.mark.asyncio
    async def test_admin_list_users_mock(mock_user_db_admin):
        # Mock find_all().skip().limit().to_list()
        mock_cursor = MagicMock()
        mock_cursor.skip.return_value = mock_cursor
        mock_cursor.limit.return_value = mock_cursor
    
        # Return a list of users
        user1 = MagicMock()
        user1.user_id = "u1"
        user1.firstname = "F1"
        user1.lastname = "L1"
        user1.role = UserRole.instructor
        user1.is_active = True
        user1.middlename = None
        user1.id = "id1"
    
        f_list = asyncio.Future()
        f_list.set_result([user1])
        mock_cursor.to_list.return_value = f_list
    
        mock_user_db_admin.find_all.return_value = mock_cursor
    
        # Mock Token Dependency to return Admin
        mock_admin = MagicMock()
        mock_admin.user_id = "admin"
        mock_admin.firstname = "Admin"
        mock_admin.lastname = "User"
        mock_admin.role = UserRole.admin
        mock_admin.hashed_password = "hash"
        # We need to mock get_current_admin_user dependency
        from app.deps import get_current_admin_user
    
        app.dependency_overrides[get_current_admin_user] = lambda: mock_admin
    
        async with AsyncClient(
            transport=ASGITransport(app=app), base_url="http://test"
        ) as ac:
>           response = await ac.get("/users")
                       ^^^^^^^^^^^^^^^^^^^^^^

tests\routers\test_admin_users_mock.py:83: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_client.py:1768: in get
    return await self.request(
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_client.py:1629: in send
    response = await self._send_handling_auth(
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_transports\asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\fastapi\applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\middleware\cors.py:85: in __call__
    await self.app(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\fastapi\middleware\asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\fastapi\routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\fastapi\routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\fastapi\routing.py:454: in app
    content = await serialize_response(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    async def serialize_response(
        *,
        field: Optional[ModelField] = None,
        response_content: Any,
        include: Optional[IncEx] = None,
        exclude: Optional[IncEx] = None,
        by_alias: bool = True,
        exclude_unset: bool = False,
        exclude_defaults: bool = False,
        exclude_none: bool = False,
        is_coroutine: bool = True,
        endpoint_ctx: Optional[EndpointContext] = None,
    ) -> Any:
        if field:
            errors = []
            if is_coroutine:
                value, errors_ = field.validate(response_content, {}, loc=("response",))
            else:
                value, errors_ = await run_in_threadpool(
                    field.validate, response_content, {}, loc=("response",)
                )
            if isinstance(errors_, list):
                errors.extend(errors_)
            if errors:
                ctx = endpoint_ctx or EndpointContext()
>               raise ResponseValidationError(
                    errors=errors,
                    body=response_content,
                    endpoint_ctx=ctx,
                )
E               fastapi.exceptions.ResponseValidationError: 1 validation error:
E                 {'type': 'string_type', 'loc': ('response', 0, 'password'), 'msg': 'Input should be a valid string', 'input': <MagicMock name='mock.password' id='1900247846928'>}
E               
E                 File "C:\Users\jhapg\OneDrive\Desktop\ClassGrid\backend\app\routers\users.py", line 42, in read_users
E                   GET /users

..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\fastapi\routing.py:292: ResponseValidationError
__________________________ test_admin_get_user_mock ___________________________

mock_user_db_admin = <MagicMock name='User' id='1900246474704'>

    @pytest.mark.asyncio
    async def test_admin_get_user_mock(mock_user_db_admin):
        # Mock find_one to return a user
        mock_user = MagicMock()
        mock_user.user_id = "target_user"
        mock_user.firstname = "Target"
        mock_user.lastname = "User"
        mock_user.role = UserRole.instructor
        mock_user.is_active = True
        mock_user.middlename = None
        mock_user.id = "target_id"
    
        f = asyncio.Future()
        f.set_result(mock_user)
        mock_user_db_admin.find_one.return_value = f
    
        mock_admin = MagicMock()
        mock_admin.user_id = "admin"
        mock_admin.firstname = "Admin"
        mock_admin.lastname = "User"
        mock_admin.role = UserRole.admin
        mock_admin.hashed_password = "hash"
        from app.deps import get_current_admin_user
    
        app.dependency_overrides[get_current_admin_user] = lambda: mock_admin
    
        async with AsyncClient(
            transport=ASGITransport(app=app), base_url="http://test"
        ) as ac:
>           response = await ac.get("/users/target_user")
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\routers\test_admin_users_mock.py:121: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_client.py:1768: in get
    return await self.request(
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_client.py:1629: in send
    response = await self._send_handling_auth(
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_transports\asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\fastapi\applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\middleware\cors.py:85: in __call__
    await self.app(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\fastapi\middleware\asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\fastapi\routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\fastapi\routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\fastapi\routing.py:454: in app
    content = await serialize_response(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    async def serialize_response(
        *,
        field: Optional[ModelField] = None,
        response_content: Any,
        include: Optional[IncEx] = None,
        exclude: Optional[IncEx] = None,
        by_alias: bool = True,
        exclude_unset: bool = False,
        exclude_defaults: bool = False,
        exclude_none: bool = False,
        is_coroutine: bool = True,
        endpoint_ctx: Optional[EndpointContext] = None,
    ) -> Any:
        if field:
            errors = []
            if is_coroutine:
                value, errors_ = field.validate(response_content, {}, loc=("response",))
            else:
                value, errors_ = await run_in_threadpool(
                    field.validate, response_content, {}, loc=("response",)
                )
            if isinstance(errors_, list):
                errors.extend(errors_)
            if errors:
                ctx = endpoint_ctx or EndpointContext()
>               raise ResponseValidationError(
                    errors=errors,
                    body=response_content,
                    endpoint_ctx=ctx,
                )
E               fastapi.exceptions.ResponseValidationError: 1 validation error:
E                 {'type': 'string_type', 'loc': ('response', 'password'), 'msg': 'Input should be a valid string', 'input': <MagicMock name='mock.password' id='1900247854320'>}
E               
E                 File "C:\Users\jhapg\OneDrive\Desktop\ClassGrid\backend\app\routers\users.py", line 52, in read_user
E                   GET /users/{user_id}

..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\fastapi\routing.py:292: ResponseValidationError
_________________________ test_admin_update_user_mock _________________________

mock_user_db_admin = <MagicMock name='User' id='1900247855664'>

    @pytest.mark.asyncio
    async def test_admin_update_user_mock(mock_user_db_admin):
        # Mock find_one to return the user to update
        mock_instance = mock_user_db_admin.return_value  # Default mock instance
        f = asyncio.Future()
        f.set_result(mock_instance)
        mock_user_db_admin.find_one.return_value = f
    
        mock_admin = MagicMock()
        mock_admin.user_id = "admin"
        mock_admin.firstname = "Admin"
        mock_admin.lastname = "User"
        mock_admin.role = UserRole.admin
        mock_admin.hashed_password = "hash"
        from app.deps import get_current_admin_user
    
        app.dependency_overrides[get_current_admin_user] = lambda: mock_admin
    
        async with AsyncClient(
            transport=ASGITransport(app=app), base_url="http://test"
        ) as ac:
>           response = await ac.put("/users/test_user", json={"firstname": "UpdatedName"})
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\routers\test_admin_users_mock.py:150: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_client.py:1896: in put
    return await self.request(
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_client.py:1629: in send
    response = await self._send_handling_auth(
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_transports\asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\fastapi\applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\middleware\cors.py:85: in __call__
    await self.app(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\fastapi\middleware\asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\fastapi\routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\fastapi\routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\fastapi\routing.py:454: in app
    content = await serialize_response(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    async def serialize_response(
        *,
        field: Optional[ModelField] = None,
        response_content: Any,
        include: Optional[IncEx] = None,
        exclude: Optional[IncEx] = None,
        by_alias: bool = True,
        exclude_unset: bool = False,
        exclude_defaults: bool = False,
        exclude_none: bool = False,
        is_coroutine: bool = True,
        endpoint_ctx: Optional[EndpointContext] = None,
    ) -> Any:
        if field:
            errors = []
            if is_coroutine:
                value, errors_ = field.validate(response_content, {}, loc=("response",))
            else:
                value, errors_ = await run_in_threadpool(
                    field.validate, response_content, {}, loc=("response",)
                )
            if isinstance(errors_, list):
                errors.extend(errors_)
            if errors:
                ctx = endpoint_ctx or EndpointContext()
>               raise ResponseValidationError(
                    errors=errors,
                    body=response_content,
                    endpoint_ctx=ctx,
                )
E               fastapi.exceptions.ResponseValidationError: 1 validation error:
E                 {'type': 'string_type', 'loc': ('response', 'password'), 'msg': 'Input should be a valid string', 'input': <MagicMock name='User().password' id='1900247858016'>}
E               
E                 File "C:\Users\jhapg\OneDrive\Desktop\ClassGrid\backend\app\routers\users.py", line 66, in update_user
E                   PUT /users/{user_id}

..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\fastapi\routing.py:292: ResponseValidationError
_________________________ test_admin_delete_user_mock _________________________

mock_user_db_admin = <MagicMock name='User' id='1900247858688'>

    @pytest.mark.asyncio
    async def test_admin_delete_user_mock(mock_user_db_admin):
        # Mock find_one to return the user to delete
        mock_instance = mock_user_db_admin.return_value
        f = asyncio.Future()
        f.set_result(mock_instance)
        mock_user_db_admin.find_one.return_value = f
    
        mock_admin = MagicMock()
        mock_admin.user_id = "admin"
        mock_admin.firstname = "Admin"
        mock_admin.lastname = "User"
        mock_admin.role = UserRole.admin
        mock_admin.hashed_password = "hash"
        from app.deps import get_current_admin_user
    
        app.dependency_overrides[get_current_admin_user] = lambda: mock_admin
    
        async with AsyncClient(
            transport=ASGITransport(app=app), base_url="http://test"
        ) as ac:
>           response = await ac.delete("/users/test_user")
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\routers\test_admin_users_mock.py:181: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_client.py:1966: in delete
    return await self.request(
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_client.py:1629: in send
    response = await self._send_handling_auth(
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\httpx\_transports\asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\fastapi\applications.py:1138: in __call__
    await super().__call__(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\middleware\cors.py:85: in __call__
    await self.app(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\fastapi\middleware\asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\fastapi\routing.py:124: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\fastapi\routing.py:110: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\fastapi\routing.py:454: in app
    content = await serialize_response(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    async def serialize_response(
        *,
        field: Optional[ModelField] = None,
        response_content: Any,
        include: Optional[IncEx] = None,
        exclude: Optional[IncEx] = None,
        by_alias: bool = True,
        exclude_unset: bool = False,
        exclude_defaults: bool = False,
        exclude_none: bool = False,
        is_coroutine: bool = True,
        endpoint_ctx: Optional[EndpointContext] = None,
    ) -> Any:
        if field:
            errors = []
            if is_coroutine:
                value, errors_ = field.validate(response_content, {}, loc=("response",))
            else:
                value, errors_ = await run_in_threadpool(
                    field.validate, response_content, {}, loc=("response",)
                )
            if isinstance(errors_, list):
                errors.extend(errors_)
            if errors:
                ctx = endpoint_ctx or EndpointContext()
>               raise ResponseValidationError(
                    errors=errors,
                    body=response_content,
                    endpoint_ctx=ctx,
                )
E               fastapi.exceptions.ResponseValidationError: 1 validation error:
E                 {'type': 'string_type', 'loc': ('response', 'password'), 'msg': 'Input should be a valid string', 'input': <MagicMock name='User().password' id='1900251155488'>}
E               
E                 File "C:\Users\jhapg\OneDrive\Desktop\ClassGrid\backend\app\routers\users.py", line 94, in delete_user
E                   DELETE /users/{user_id}

..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\fastapi\routing.py:292: ResponseValidationError
_________________________________ test_login __________________________________

    @pytest.mark.asyncio
    async def test_login():
        # init_db is handled by autouse fixture
    
        # Create a user manually
        user_id = "testlogin_user"
        password = "password123"
        hashed = get_password_hash(password)
    
>       existing_user = await User.find_one(User.user_id == user_id)
                                            ^^^^^^^^^^^^

tests\routers\test_auth.py:18: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <class 'app.models.user.User'>, item = 'user_id'

    def __getattr__(self, item: str) -> Any:
        """This is necessary to keep attribute access working for class attribute access."""
        private_attributes = self.__dict__.get('__private_attributes__')
        if private_attributes and item in private_attributes:
            return private_attributes[item]
>       raise AttributeError(item)
E       AttributeError: user_id

..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\pydantic\_internal\_model_construction.py:271: AttributeError
_______________________ test_create_instructor_success ________________________

mock_user_db = <MagicMock name='User' id='1900251156496'>

    @pytest.mark.asyncio
    async def test_create_instructor_success(mock_user_db):
>       mock_admin = User(
            user_id="admin_user",
            firstname="Admin",
            lastname="User",
            role=UserRole.admin,
            hashed_password="hash",
        )

tests\routers\test_users_mock.py:43: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = User(), args = ()
kwargs = {'firstname': 'Admin', 'hashed_password': 'hash', 'lastname': 'User', 'role': <UserRole.admin: 'admin'>, ...}

    def __init__(self, *args: Any, **kwargs: Any) -> None:
>       super(Document, self).__init__(*args, **kwargs)
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for User
E       password
E         Field required [type=missing, input_value={'user_id': 'admin_user',...ashed_password': 'hash'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\beanie\odm\documents.py:208: ValidationError
_______________________ test_create_user_existing_email _______________________

mock_user_db = <MagicMock name='User' id='1900251157840'>

    @pytest.mark.asyncio
    async def test_create_user_existing_email(mock_user_db):
>       mock_admin = User(
            user_id="admin_user",
            firstname="Admin",
            lastname="User",
            role=UserRole.admin,
            hashed_password="hash",
        )

tests\routers\test_users_mock.py:82: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = User(), args = ()
kwargs = {'firstname': 'Admin', 'hashed_password': 'hash', 'lastname': 'User', 'role': <UserRole.admin: 'admin'>, ...}

    def __init__(self, *args: Any, **kwargs: Any) -> None:
>       super(Document, self).__init__(*args, **kwargs)
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for User
E       password
E         Field required [type=missing, input_value={'user_id': 'admin_user',...ashed_password': 'hash'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\beanie\odm\documents.py:208: ValidationError
=========================== short test summary info ===========================
FAILED tests/core/test_db.py::test_db_connection - beanie.exceptions.Collecti...
FAILED tests/routers/test_admin_users_mock.py::test_admin_list_users_mock - f...
FAILED tests/routers/test_admin_users_mock.py::test_admin_get_user_mock - fas...
FAILED tests/routers/test_admin_users_mock.py::test_admin_update_user_mock - ...
FAILED tests/routers/test_admin_users_mock.py::test_admin_delete_user_mock - ...
FAILED tests/routers/test_auth.py::test_login - AttributeError: user_id
FAILED tests/routers/test_users_mock.py::test_create_instructor_success - pyd...
FAILED tests/routers/test_users_mock.py::test_create_user_existing_email - py...
ERROR tests/routers/test_admin_users.py::test_admin_list_users
ERROR tests/routers/test_admin_users.py::test_admin_get_user
ERROR tests/routers/test_admin_users.py::test_admin_update_user
ERROR tests/routers/test_admin_users.py::test_admin_delete_user
ERROR tests/routers/test_users.py::test_admin_create_instructor - AttributeEr...
ERROR tests/routers/test_users.py::test_admin_create_program_chairperson - At...
ERROR tests/routers/test_users.py::test_user_cannot_create_user - AttributeEr...
ERROR tests/routers/test_users.py::test_admin_create_admin - AttributeError: ...
==================== 8 failed, 1 passed, 8 errors in 2.20s ====================
